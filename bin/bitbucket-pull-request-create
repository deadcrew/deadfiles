#!/bin/bash

set -euo pipefail

:get-commit-ref() {
    local commit=$1
    git show-ref | grep -P "$commit refs/remotes/origin/(?!HEAD)" \
    | rev | cut -f1 -d"/" | rev
}

:is-commit-an-origin-reference() {
    local commit=$1
    git show-ref | grep -qP "$commit refs/remotes/origin/(?!HEAD)"
}

:get-parents() {
    local commit=$1
    git rev-list --parents $commit
}

:get-prev-commit() {
    local commit=$1
    :get-parents $commit | head -n1 | cut -d' ' -f2
}

:get-destination-branch() {
    local head=$1
    local prev_commit=$(:get-prev-commit $head)

    if :is-commit-an-origin-reference $prev_commit; then
        :get-commit-ref $prev_commit
    elif [[ $(:get-parents $prev_commit | wc -l) != 1 ]]; then
        :get-destination-branch $prev_commit
    fi
}

:get-source-branch() {
    git symbolic-ref HEAD --short
}

:get-pull-request-url() {
    local source=$1
    local destination=$2
    bitbucket pull-request $source $destination
}

:parse-opts() {
    local _opts=$1

    shift 1

    eval set -- $(getopt -o hdv -- "${@}")
    while [ $# -gt 0 ]; do
        case $1 in
            -d)
                eval $_opts\[dryrun\]=true
                ;;
            -v)
                eval $_opts\[verbose\]=true
                ;;
            -h)
                :usage
                exit 1
        esac

        shift
    done
}

:add-git-config() {
    local basename=$1
    local key=$2
    local value=$3
    git config --local $basename.$key $value
}

:usage() {
        cat <<HELP
Usage:
    bitbucket-pull-request-create [-h] [-d] [-v]

Examples:
    $ bitbucket-pull-request-create
        > will create current branch to it's parent branch pull request

    $ bitbucket-pull-request-create -d
        > will print source and destination branch and exit

Options:
    -v  Be verbose.
    -d  Dry run mode.
    -h  Print this text.
HELP

}

:main() {
    local opts
    typeset -A opts

    opts[dryrun]=false
    opts[verbose]=false

    :parse-opts opts "${@}"

    local source=$(:get-source-branch)
    if ${opts[verbose]}; then
        echo source branch: $source
    fi

    local destination=$(:get-destination-branch HEAD)
    if ${opts[verbose]}; then
        echo destination branch: $destination
    fi

    if ${opts[dryrun]} ; then
        echo pull request branch $source -\> $destination
        exit 0
    fi

    local url=$(:get-pull-request-url $source $destination)
    if [[ ! $url =~ "^http://" ]]; then
        echo $url
        exit 1
    fi

    if ${opts[verbose]}; then
        echo bitbucket url: $url
    fi

    :add-git-config pull-request.$source to-branch $destination
    :add-git-config pull-request.$source url $url
}

:main "${@}"
