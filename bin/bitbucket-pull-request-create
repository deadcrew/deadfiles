#!/bin/bash

set -euo pipefail

:get-commit-ref() {
    local commit=$1
    git show-ref | grep -P "$commit refs/remotes/origin/(?!HEAD)" \
    | rev | cut -f1 -d"/" | rev
}

:is-commit-an-origin-reference() {
    local commit=$1
    git show-ref | grep -qP "$commit refs/remotes/origin/(?!HEAD)"
}

:get-parents() {
    local commit=$1
    git rev-list --parents $commit
}

:get-prev-commit() {
    local commit=$1
    :get-parents $commit | head -n1 | cut -d' ' -f2
}

:get-destination-branch() {
    local head=$1
    local prev_commit=$(:get-prev-commit $head)

    if :is-commit-an-origin-reference $prev_commit; then
        :get-commit-ref $prev_commit
    elif [[ $(:get-parents $prev_commit | wc -l) != 1 ]]; then
        :get-destination-branch $prev_commit
    fi
}

:get-source-branch() {
    git symbolic-ref HEAD --short
}

:get-pull-request-url() {
    local source=$1
    local destination=$2
    bitbucket pull-request $source $destination
}

:parse-opts() {
    eval set -- $(getopt -o h -- "${@}")
    while [ $# -gt 0 ]; do
        case $1 in
            -h)
                :usage
                exit 1
        esac

        shift
    done
}

:add-git-config() {
    local basename=$1
    local key=$2
    local value=$3
    git config --local $basename.$key $value
}

:usage() {
        cat <<HELP
Usage:
    bitbucket-pull-request-create [-h]

Examples:
    $ bitbucket-pull-request-create
        > will create current branch to it's parent branch pull request

Options:
    -h  Print this text.
HELP

}

:main() {
    :parse-opts "${@}"

    from=$(:get-source-branch)
    to=$(:get-destination-branch HEAD)
    url=$(
        :get-pull-request-url $from $to
    )

    :add-git-config pull-request.$from to-branch $to
    :add-git-config pull-request.$from url $url
}

:main "${@}"
