#!/usr/bin/expect -f

set prompt "#"
set address [lindex $argv 0]

spawn sudo systemctl start bluetooth.service
spawn sudo bluetoothctl

expect "Agent registered"
send "show\n"
expect {
    "Powered: no" {
        send "power on\r"
        expect -re "Controller .* Powered: yes"
    }

    "Powered: yes"
}

send "connect $address\r"
expect {
    "Failed to connect" {
        send "remove $address\r"
        exp_continue
    }

    -re "Device $address not available|Device has been removed" {
        send "scan on\r"
        expect "Discovery started"
        expect -re "\[NEW\] Device $address"
        send "pair $address\r"
        expect "Pairing successful"
        expect -re "\[CHG\] $address Connected: no"
        send "scan off\r"
        send "connect $address\r"
    }
}

expect -re "Connection "
send "quit\r"
expect eof
