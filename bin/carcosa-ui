#!/bin/bash

set -euo pipefail

SECRETS_REPOSITORY=${SECRETS_REPOSITORY:-$HOME/.secrets/}

if ! cd "${SECRETS_REPOSITORY}"; then
    notify-send "$SECRETS_REPOSITORY does not exist."
    exit 1
fi

if ! carcosa -Fc; then
    notify-send "carcosa" "Master password key cache file is not found."
    exit 1
fi

if output=$(carcosa -Lc \
    | sort \
    | dmenu -f -i -b -l 20 2>/dev/null \
    | perl -p -e 'chomp if eof' \
    | xargs -r0 carcosa -Gc 2>&1)
then
    screenkey_pid=$(pgrep -f screenkey || true)

    if [[ "$screenkey_pid" ]]; then
        screenkey_cmdline=$(cat /proc/$screenkey_pid/cmdline | tr '\0' '\n')
        pkill -f screenkey

        while pgrep -f screenkey > /dev/null; do
            sleep 0.1
        done
    fi

    cat <<< "$output" \
        | perl -p -e 'chomp if eof' \
        | xdotool type --clearmodifiers --delay 1 --file -

    xdotool \
        keyup --clearmodifiers Return \
        key --clearmodifiers Return

    if [[ "$screenkey_pid" ]]; then
        exec xargs -d'\n' sh -c 'exec "$0" "${@}"'<<< "$screenkey_cmdline"
    fi
else
    if [ "$output" ]; then
        notify-send carcosa "$output"
    fi
fi
