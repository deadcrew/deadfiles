#!/bin/bash

set -x
HISTORY=~/.engrus_history

no_blank_header=false

while getopts "e" key; do
    case "$key" in
        e)
            no_blank_header=true
            shift
            ;;
    esac
done

if [[ $# -ne 0 ]]; then
    INPUT="$@"
else
    INPUT=$(modal <&-)
fi

INPUT_LANG="en-ru"
if ! grep -qiE '[a-z]' <<< "$INPUT"; then
    INPUT_LANG="ru-en"
fi

header=" "
if $no_blank_header; then
    header="$INPUT"
fi

if [ "$(wc -w <<< "$INPUT")" == "1" ]; then
    while read result; do
        notify-send -t 2000 "$header" -- "$result"
        echo "$INPUT"$'\t'$result >> $HISTORY
        echo $result
        exit 0
    done < <(runki --lang $INPUT_LANG 2>/dev/null <<< "$INPUT")
fi

curl -k -s \
        -d "key=trnsl.1.1.20150807T071843Z.319e163bafb5d806.f17c493a466253265a817c9f96a74db85f6b556b" \
        -d "lang=$INPUT_LANG" \
        -d "text=$INPUT" \
        -G "https://translate.yandex.net/api/v1.5/tr.json/translate" \
    | jq -r '.text[0]' \
    | \
    while read result; do
        notify-send -t 2000 "$header" -- "$result"
        echo "$INPUT"$'\t'$result >> $HISTORY
        echo $result
    done
