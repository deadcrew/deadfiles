#!/bin/bash

set -euo pipefail

if [[ "$*" ]]; then
    dir=$(mktemp -dt rebirth.XXXXXX)
    trap "rm -r $dir" EXIT ERR

    printf "%s\n" "$*" >$dir/cmd

    while :; do
        { coproc { "$@"; } >&3; } 3>&1
        printf "%d\n" "$COPROC_PID" >$dir/pid
        if ! wait $COPROC_PID; then
            :
        fi
        echo "> reborn" >&2
    done
else
    for dir in ${TMPDIR:-/tmp}/rebirth.*; do
        cmd=$(cat $dir/cmd)
        pid=$(cat $dir/pid)
        if pkill -INT -P $pid; then
            echo "killed {$pid} $cmd" >&2
        else
            echo "unable to kill {$pid} $cmd" >&2
        fi
    done
fi
