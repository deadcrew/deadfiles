#!/bin/bash

:map-outputs() {
    local connected=false

    while read line; do
        if [[ "$line" =~ "disconnected " ]]; then
            connected=false
            continue
        elif [[ "$line" =~ "connected " ]]; then
            connected=true
            output="${line%% *}"
        else
            if $connected && [[ "$line" =~ ^[0-9]+x[0-9]+ ]]; then
                read size rate _ <<< "$line"

                printf "%s %s %s\n" "$size" "$rate" "$output"
            fi
        fi
    done
}

#udevadm settle --timeout=1

read mode _ output <<< $(
    xrandr \
        | :map-outputs \
        | awk '$2 > 31' \
        | sort -nr \
        | head -n1
)

echo "OUTPUT=$output"
echo "MODE=$mode"

xrandr --output "$output" --mode "$mode"

xrandr \
    | grep -vFw "$output" \
    | grep -Fw "connected" \
    | awk '{ print $1 }' \
    | xargs -n1 -I{} xrandr --output {} --off

i3-msg restart
killall keynav
