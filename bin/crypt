#!/bin/bash

set -euo pipefail

:main() {
    local disk
    local path

    for disk in /dev/disk/by-path/*; do
        if sudo cryptsetup isLuks "$disk"; then
            path=$(readlink -f "$disk")
            break
        fi
    done

    if [[ ! "${path:-}" ]]; then
        :info 'Encrypted device not found.'
        exit 1
    fi

    local name=$(md5sum <<< $disk | awk '{print $1}')
    local target="/mnt/crypt-$name"

    if findmnt "$target" > /dev/null; then
        local link="$(:get_link "$target")"
        if [[ "$link" ]]; then
            :shell "$link"
        else
            :shell "$target"
        fi
    fi

    sudo cryptsetup open "$path" "$name"

    sudo mkdir -p "$target"

    if ! sudo mount -o uid=$UID "/dev/mapper/$name" "$target"; then
        sudo mount "/dev/mapper/$name" "$target"
    fi

    local link="$(:get_link "$target")"
    if [[ "$link" ]]; then
        :link "$target" "$link"

        target="$link"
    fi

    trap ":cleanup $name" EXIT

    :info 'Starting shell at encrypted device.'
    :info 'Device will be closed after shell exit.'

    ( :shell "$target" )

    :info 'Closing encrypted device.'
}


:info() {
    echo "$(highlight bold)$*$(highlight reset)"
}

:debug() {
    echo "$*"
}

:get_link() {
    local target=$1

    if [[ -f "$target/.link" ]]; then
        cat "$target/.link"
    fi
}

:link() {
    local target=$1
    local link=$2

    if [[ -e "$link" ]]; then
        sudo unlink "$link"
    fi

    sudo ln -s "$target" "$link"
}

:shell() {
    local dir=$1

    cd "$dir" && exec $SHELL -i
}

:cleanup() {
    local name=$1

    sudo umount "/dev/mapper/$name"
    sudo cryptsetup close "$name"
}

:main "$@"
