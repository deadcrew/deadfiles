#!/bin/bash

suspend_notify_timeout=${SUSPEND_NOTIFY_TIMEOUT:-120}

:is-suspened() {
    ps -C upwork -o s= | grep -qF T
}

:list-pids() {
    ps -o pgid= $(pgrep -x upwork) | sort | uniq | paste -sd,
}

:main() {
    if :is-suspened; then
        pkill -CONT -g $(:list-pids)
        notify-send "upwork" "<b>UPWORK</b> RESUMED"
    else
        pkill -STOP -g $(:list-pids)
        notify-send "upwork" "<b>UPWORK</b> SUSPENDED"

        {
            counter=0
            while sleep 1; do
                if :is-suspened; then
                    counter=$((counter + 1))

                    if [[ "$counter" -gt ${suspend_notify_timeout} ]]; then
                        counter=0

                        notify-send "upwork" "<b>UPWORK</b> STILL SUSPENDED"
                    fi
                else
                    break
                fi
            done
        }
    fi
}

:main "$@"
