#!/bin/bash

if [[ "$1" == "-w" ]]; then
    shift
    select_window=1

    if [ "$2" ]; then
        window_id="$1"
        shift
    fi
fi

if [[ "$1" == "-g" && "$2" ]]; then
    shift
    select_geometry="$1"
    shift
fi

audio=""
if [[ "$1" == "-a" ]]; then
    shift
    audio="-f pulse -ac 2 -i default"
fi

if [[ $# -lt 1 || "$1" == "-h" ]]; then
    echo usage: "$0 [-w [window_id]] <video.avi>"
    exit 1
fi

name="$1"

if [[ "$select_window" ]]; then
    if [ -z "$window_id" ]; then
        window_id=$(xwininfo | awk '/Window id/{print $4}')
    fi
    select_arg="-#$window_id"
    echo "Press ScrollLock to start recording."
    killall -q -STOP screenkey

    xdotool windowfocus $window_id

    xev -id "$window_id" | while read line; do
        if grep "keycode 78" <<< "$line"; then
            break
        fi
    done

    killall -q -CONT screenkey
else
    select_arg="-s"
fi

if [[ "$select_geometry" ]]; then
    select_arg="-g $select_geometry"
fi

video="$name".avi

if [[ "$window_id" ]]; then
    {
        echo "Press ScrollLock to stop recording."
        killall -q -STOP screenkey

        xdotool windowfocus $window_id

        xev -id "$window_id" | while read line; do
            if grep "keycode 78" <<< "$line"; then
                break
            fi
        done

        pkill -SIGINT ffmpeg
        #pkill -SIGINT ffmpeg
    } &
fi

set -x
ffcast $select_arg % \
    ffmpeg $audio -f x11grab -framerate 25 -video_size %s \
    -i %D+%c -codec:v libx264 -b:v 20000k \
    -vf crop="iw-mod(iw\\,2):ih-mod(ih\\,2)" -y -c:a copy "$video"

#sleep 1

#clear

#video-to-gif "$video" "$name" && rm "$video"

